# ??????????
$baseUrl = "http://localhost:8080"
$userId = 1
$sessionId = "test-" + [DateTime]::Now.Ticks

Write-Host "???????.." -ForegroundColor Cyan

# ???1: ??????
Write-Host "1. ?????????..." -ForegroundColor Cyan
$chatRequest = @{
    userId = $userId
    sessionId = $sessionId
    message = "????????????????????
    context = @{
        currentPage = "home"
    }
} | ConvertTo-Json

try {
    $response = Invoke-RestMethod -Uri "$baseUrl/api/customer-service/chat" -Method POST -Body $chatRequest -ContentType "application/json"
    Write-Host "??????????????" -ForegroundColor Green
    Write-Host "  - ???: $($response.data.response)" -ForegroundColor White
} catch {
    Write-Host "??????????????: $($_.Exception.Message)" -ForegroundColor Red
}

# ???2: ??????
Write-Host "2. ?????????..." -ForegroundColor Cyan
try {
    # ????????
    $startTime = Get-Date
    $response1 = Invoke-RestMethod -Uri "$baseUrl/api/customer-service/chat" -Method POST -Body $chatRequest -ContentType "application/json"
    $firstRequestTime = ((Get-Date) - $startTime).TotalMilliseconds
    
    # ????????????????????
    $startTime = Get-Date
    $response2 = Invoke-RestMethod -Uri "$baseUrl/api/customer-service/chat" -Method POST -Body $chatRequest -ContentType "application/json"
    $secondRequestTime = ((Get-Date) - $startTime).TotalMilliseconds
    
    Write-Host "??????????????" -ForegroundColor Green
    Write-Host "  - ??????????? $([Math]::Round($firstRequestTime, 2))ms" -ForegroundColor White
    Write-Host "  - ??????????? $([Math]::Round($secondRequestTime, 2))ms" -ForegroundColor White
    Write-Host "  - ??????????? $($response2.data.cacheHit)" -ForegroundColor White
    
    if ($response2.data.cacheHit -and $secondRequestTime -lt $firstRequestTime) {
        Write-Host "  ?????????????????????????" -ForegroundColor Green
        $improvement = (1 - ($secondRequestTime / $firstRequestTime)) * 100
        Write-Host "  - ??????: $([Math]::Round($improvement, 2))%" -ForegroundColor Green
    } else {
        Write-Host "  ??????????????????? -ForegroundColor Yellow
    }
} catch {
    Write-Host "??????????????: $($_.Exception.Message)" -ForegroundColor Red
}

# ???3: ?????????
Write-Host "3. ????????????..." -ForegroundColor Cyan
$transferSessionId = "transfer-" + [DateTime]::Now.Ticks

$transferRequest = @{
    userId = $userId
    sessionId = $transferSessionId
    reason = "??????????
} | ConvertTo-Json

try {
    $response = Invoke-RestMethod -Uri "$baseUrl/api/human-service/transfer" -Method POST -Body $transferRequest -ContentType "application/json"
    Write-Host "?????????????????" -ForegroundColor Green
    Write-Host "  - ???ID: $($response.data.sessionId)" -ForegroundColor White
    Write-Host "  - ???? $($response.data.status)" -ForegroundColor White
    
    # ?????????ID
    $humanServiceSessionId = $response.data.sessionId
    
    # ??????????
    if ($humanServiceSessionId) {
        $statusResponse = Invoke-RestMethod -Uri "$baseUrl/api/human-service/status?sessionId=$humanServiceSessionId" -Method GET
        Write-Host "  - ??????: $($statusResponse.data.queuePosition)" -ForegroundColor White
        Write-Host "  - ?????????: $($statusResponse.data.estimatedWaitTime)???" -ForegroundColor White
    }
} catch {
    Write-Host "?????????????????: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "??????!" -ForegroundColor Cyan 

// ==================== é…ç½®ç±» ====================

// 1. Redisé…ç½®ç±»
@Configuration
@EnableCaching
@ConfigurationProperties(prefix = "spring.redis")
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // JSONåºåˆ—åŒ–é…ç½®
        GenericJackson2JsonRedisSerializer jsonSerializer = new GenericJackson2JsonRedisSerializer();
        StringRedisSerializer stringSerializer = new StringRedisSerializer();
        
        template.setKeySerializer(stringSerializer);
        template.setValueSerializer(jsonSerializer);
        template.setHashKeySerializer(stringSerializer);
        template.setHashValueSerializer(jsonSerializer);
        
        template.afterPropertiesSet();
        return template;
    }
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(1))
            .disableCachingNullValues()
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .transactionAware()
            .build();
    }
}

// ==================== æ ¸å¿ƒå®ä½“ç±» ====================

// 2. å¯¹è¯ä¸Šä¸‹æ–‡å®ä½“
@Data
@NoArgsConstructor
@AllArgsConstructor
@JsonIgnoreProperties(ignoreUnknown = true)
public class ChatContext implements Serializable {
    private String sessionId;
    private Long userId;
    private Long currentProductId;
    private BigDecimal currentProductPrice;
    private String currentProductName;
    private String currentIntent;
    private int promotionAttempts = 0;
    private boolean creditCardPromoted = false;
    private List<String> viewedProducts = new ArrayList<>();
    private LocalDateTime lastActivity;
    private Map<String, Object> metadata = new HashMap<>();
    
    public ChatContext(String sessionId) {
        this.sessionId = sessionId;
        this.lastActivity = LocalDateTime.now();
    }
    
    public void updateActivity() {
        this.lastActivity = LocalDateTime.now();
    }
    
    public void addViewedProduct(String productId) {
        if (!viewedProducts.contains(productId)) {
            viewedProducts.add(productId);
            if (viewedProducts.size() > 10) {
                viewedProducts.remove(0); // ä¿æŒæœ€è¿‘10ä¸ªå•†å“
            }
        }
    }
    
    public boolean shouldPromoteCreditCard() {
        return !creditCardPromoted && promotionAttempts < 3;
    }
    
    public void recordPromotionAttempt() {
        this.promotionAttempts++;
        this.creditCardPromoted = true;
    }
}

// 3. ç”¨æˆ·ä¿¡ç”¨å¡ä¿¡æ¯å®ä½“
@Data
@Entity
@Table(name = "user_credit_card")
@JsonIgnoreProperties({"hibernateLazyInitializer", "handler"})
public class UserCreditCard implements Serializable {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "user_id", unique = true)
    private Long userId;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "card_level")
    private CardLevel cardLevel;
    
    @Column(name = "points_balance")
    private Integer pointsBalance = 0;
    
    @Column(name = "points_expiring")
    private Integer pointsExpiring = 0;
    
    @Column(name = "expiring_date")
    private LocalDate expiringDate;
    
    @Column(name = "credit_limit")
    private BigDecimal creditLimit;
    
    @Column(name = "bill_date")
    private Integer billDate;
    
    @Column(name = "due_date")
    private Integer dueDate;
    
    @CreationTimestamp
    @Column(name = "created_time")
    private LocalDateTime createdTime;
    
    @UpdateTimestamp
    @Column(name = "updated_time")
    private LocalDateTime updatedTime;
    
    public enum CardLevel {
        BASIC("åŸºç¡€å¡", 0.005),
        GOLD("é‡‘å¡", 0.01),
        PLATINUM("ç™½é‡‘å¡", 0.015),
        DIAMOND("é’»çŸ³å¡", 0.02);
        
        private final String displayName;
        private final double pointsRate;
        
        CardLevel(String displayName, double pointsRate) {
            this.displayName = displayName;
            this.pointsRate = pointsRate;
        }
        
        public String getDisplayName() { return displayName; }
        public double getPointsRate() { return pointsRate; }
    }
}

// ==================== ç¼“å­˜æœåŠ¡å±‚ ====================

// 4. Redisç¼“å­˜æœåŠ¡
@Service
@Slf4j
public class RedisCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç¼“å­˜é”®å‰ç¼€å¸¸é‡
    private static final String AI_RESPONSE_PREFIX = "ai_response:";
    private static final String CHAT_CONTEXT_PREFIX = "chat_context:";
    private static final String USER_CARD_PREFIX = "user_card:";
    private static final String FAQ_PREFIX = "faq:";
    private static final String USER_BEHAVIOR_PREFIX = "user_behavior:";
    
    // =========================== AIå“åº”ç¼“å­˜ ===========================
    
    public String getCachedAIResponse(String question, String contextHash) {
        String key = AI_RESPONSE_PREFIX + DigestUtils.md5Hex(question + contextHash);
        return (String) redisTemplate.opsForValue().get(key);
    }
    
    public void cacheAIResponse(String question, String contextHash, String response) {
        String key = AI_RESPONSE_PREFIX + DigestUtils.md5Hex(question + contextHash);
        redisTemplate.opsForValue().set(key, response, 1, TimeUnit.HOURS);
        log.debug("AIå“åº”å·²ç¼“å­˜: {}", key);
    }
    
    // =========================== å¯¹è¯ä¸Šä¸‹æ–‡ç¼“å­˜ ===========================
    
    public void saveContext(ChatContext context) {
        String key = CHAT_CONTEXT_PREFIX + context.getSessionId();
        context.updateActivity();
        redisTemplate.opsForValue().set(key, context, 30, TimeUnit.MINUTES);
        log.debug("å¯¹è¯ä¸Šä¸‹æ–‡å·²ä¿å­˜: {}", key);
    }
    
    public ChatContext getContext(String sessionId) {
        String key = CHAT_CONTEXT_PREFIX + sessionId;
        ChatContext context = (ChatContext) redisTemplate.opsForValue().get(key);
        if (context != null) {
            context.updateActivity();
            // å»¶é•¿TTL
            redisTemplate.expire(key, 30, TimeUnit.MINUTES);
        }
        return context;
    }
    
    public ChatContext getOrCreateContext(String sessionId, Long userId) {
        ChatContext context = getContext(sessionId);
        if (context == null) {
            context = new ChatContext(sessionId);
            context.setUserId(userId);
            saveContext(context);
        }
        return context;
    }
    
    // =========================== ç”¨æˆ·ä¿¡ç”¨å¡ç¼“å­˜ ===========================
    
    public void cacheUserCard(UserCreditCard userCard) {
        String key = USER_CARD_PREFIX + userCard.getUserId();
        redisTemplate.opsForValue().set(key, userCard, 10, TimeUnit.MINUTES);
        log.debug("ç”¨æˆ·ä¿¡ç”¨å¡ä¿¡æ¯å·²ç¼“å­˜: {}", key);
    }
    
    public UserCreditCard getCachedUserCard(Long userId) {
        String key = USER_CARD_PREFIX + userId;
        return (UserCreditCard) redisTemplate.opsForValue().get(key);
    }
    
    public void invalidateUserCard(Long userId) {
        String key = USER_CARD_PREFIX + userId;
        redisTemplate.delete(key);
    }
    
    // =========================== ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ ===========================
    
    public void trackUserBehavior(Long userId, String action) {
        String dateStr = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        String key = USER_BEHAVIOR_PREFIX + userId + ":" + dateStr;
        
        redisTemplate.opsForHash().increment(key, action, 1);
        redisTemplate.expire(key, 7, TimeUnit.DAYS);
        
        log.debug("ç”¨æˆ·è¡Œä¸ºå·²è®°å½•: userId={}, action={}", userId, action);
    }
    
    public Map<Object, Object> getUserBehaviorStats(Long userId, LocalDate date) {
        String dateStr = date.format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        String key = USER_BEHAVIOR_PREFIX + userId + ":" + dateStr;
        return redisTemplate.opsForHash().entries(key);
    }
    
    // =========================== ç¼“å­˜ç»Ÿè®¡å’Œç®¡ç† ===========================
    
    public CacheStats getCacheStats() {
        try {
            Properties info = redisTemplate.getConnectionFactory().getConnection().info("memory");
            
            return CacheStats.builder()
                .usedMemory(info.getProperty("used_memory_human"))
                .maxMemory(info.getProperty("maxmemory_human"))
                .hitRate(calculateHitRate())
                .connectedClients(Integer.parseInt(info.getProperty("connected_clients", "0")))
                .build();
        } catch (Exception e) {
            log.error("è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥", e);
            return CacheStats.builder().build();
        }
    }
    
    private double calculateHitRate() {
        // ç®€å•çš„ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—
        String hitKey = "cache_stats:hits";
        String missKey = "cache_stats:misses";
        
        Long hits = (Long) redisTemplate.opsForValue().get(hitKey);
        Long misses = (Long) redisTemplate.opsForValue().get(missKey);
        
        if (hits == null) hits = 0L;
        if (misses == null) misses = 0L;
        
        long total = hits + misses;
        return total > 0 ? (double) hits / total * 100 : 0.0;
    }
    
    public void recordCacheHit() {
        redisTemplate.opsForValue().increment("cache_stats:hits");
    }
    
    public void recordCacheMiss() {
        redisTemplate.opsForValue().increment("cache_stats:misses");
    }
}

// 5. ç¼“å­˜ç»Ÿè®¡å®ä½“
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CacheStats {
    private String usedMemory;
    private String maxMemory;
    private double hitRate;
    private int connectedClients;
    private LocalDateTime timestamp = LocalDateTime.now();
}

// ==================== ä¸šåŠ¡æœåŠ¡å±‚ ====================

// 6. ç”¨æˆ·ä¿¡ç”¨å¡æœåŠ¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
@Service
@Slf4j
public class UserCreditCardService {
    
    @Autowired
    private UserCreditCardRepository cardRepository;
    
    @Autowired
    private RedisCacheService cacheService;
    
    public UserCreditCard getUserCreditCard(Long userId) {
        // å…ˆä»ç¼“å­˜è·å–
        UserCreditCard cachedCard = cacheService.getCachedUserCard(userId);
        if (cachedCard != null) {
            cacheService.recordCacheHit();
            log.debug("ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡ç”¨å¡ä¿¡æ¯: userId={}", userId);
            return cachedCard;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
        cacheService.recordCacheMiss();
        UserCreditCard dbCard = cardRepository.findByUserId(userId)
            .orElse(createDefaultCard(userId));
        
        // æ›´æ–°ç¼“å­˜
        cacheService.cacheUserCard(dbCard);
        log.debug("ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡ç”¨å¡ä¿¡æ¯: userId={}", userId);
        
        return dbCard;
    }
    
    public UserCreditCard updateUserCard(UserCreditCard userCard) {
        // æ›´æ–°æ•°æ®åº“
        UserCreditCard savedCard = cardRepository.save(userCard);
        
        // æ›´æ–°ç¼“å­˜
        cacheService.cacheUserCard(savedCard);
        
        return savedCard;
    }
    
    private UserCreditCard createDefaultCard(Long userId) {
        UserCreditCard defaultCard = new UserCreditCard();
        defaultCard.setUserId(userId);
        defaultCard.setCardLevel(UserCreditCard.CardLevel.BASIC);
        defaultCard.setPointsBalance(1000); // æ–°ç”¨æˆ·é€1000ç§¯åˆ†
        defaultCard.setCreditLimit(new BigDecimal("5000"));
        defaultCard.setBillDate(15);
        defaultCard.setDueDate(5);
        
        return cardRepository.save(defaultCard);
    }
    
    public CreditCardBenefits calculateBenefits(Long userId, BigDecimal productPrice) {
        UserCreditCard userCard = getUserCreditCard(userId);
        
        // è®¡ç®—ç§¯åˆ†
        int points = (int) (productPrice.doubleValue() * userCard.getCardLevel().getPointsRate());
        
        // è®¡ç®—å…æ¯æœŸ
        int freeInterestDays = calculateFreeInterestDays(userCard);
        
        // è®¡ç®—åˆ†æœŸä¿¡æ¯
        boolean canInstallment = productPrice.compareTo(new BigDecimal("500")) > 0;
        BigDecimal monthlyPayment = canInstallment ? 
            productPrice.divide(new BigDecimal("12"), 2, RoundingMode.HALF_UP) : null;
        
        return CreditCardBenefits.builder()
            .points(points)
            .pointsValue(points / 100.0)
            .freeInterestDays(freeInterestDays)
            .canInstallment(canInstallment)
            .monthlyPayment(monthlyPayment)
            .cardLevel(userCard.getCardLevel().getDisplayName())
            .build();
    }
    
    private int calculateFreeInterestDays(UserCreditCard userCard) {
        LocalDate today = LocalDate.now();
        LocalDate nextBillDate = getNextBillDate(userCard.getBillDate());
        LocalDate dueDate = nextBillDate.plusDays(20);
        
        return (int) ChronoUnit.DAYS.between(today, dueDate);
    }
    
    private LocalDate getNextBillDate(int billDay) {
        LocalDate today = LocalDate.now();
        LocalDate thisMonthBillDate = today.withDayOfMonth(billDay);
        
        return today.isAfter(thisMonthBillDate) ? 
            thisMonthBillDate.plusMonths(1) : thisMonthBillDate;
    }
}

// 7. AIæœåŠ¡é›†æˆï¼ˆå¸¦ç¼“å­˜ï¼‰
@Service
@Slf4j
public class AIServiceWithCache {
    
    @Autowired
    private RedisCacheService cacheService;
    
    @Value("${ai.api.url:https://ark.cn-beijing.volces.com/api/v3/chat/completions}")
    private String aiApiUrl;
    
    @Value("${ai.api.key}")
    private String aiApiKey;
    
    @Autowired
    private RestTemplate restTemplate;
    
    public String getAIResponse(String question, ChatContext context) {
        // æ„å»ºä¸Šä¸‹æ–‡å“ˆå¸Œ
        String contextHash = buildContextHash(context);
        
        // æ£€æŸ¥ç¼“å­˜
        String cachedResponse = cacheService.getCachedAIResponse(question, contextHash);
        if (cachedResponse != null) {
            cacheService.recordCacheHit();
            log.info("AIå“åº”ç¼“å­˜å‘½ä¸­: question={}", question);
            return cachedResponse;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨AI API
        cacheService.recordCacheMiss();
        try {
            String response = callAIAPI(question, context);
            
            // ç¼“å­˜å“åº”
            cacheService.cacheAIResponse(question, contextHash, response);
            
            return response;
        } catch (Exception e) {
            log.error("AI APIè°ƒç”¨å¤±è´¥", e);
            return getFallbackResponse(question, context);
        }
    }
    
    private String callAIAPI(String question, ChatContext context) {
        String prompt = buildPrompt(question, context);
        
        AIRequest request = AIRequest.builder()
            .model("ep-20241218144631-g8qvz") // è±†åŒ…æ¨¡å‹ID
            .messages(Arrays.asList(
                new AIMessage("system", buildSystemPrompt()),
                new AIMessage("user", prompt)
            ))
            .temperature(0.7)
            .maxTokens(500)
            .build();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(aiApiKey);
        
        HttpEntity<AIRequest> entity = new HttpEntity<>(request, headers);
        
        AIResponse response = restTemplate.postForObject(aiApiUrl, entity, AIResponse.class);
        
        if (response != null && response.getChoices() != null && !response.getChoices().isEmpty()) {
            return response.getChoices().get(0).getMessage().getContent();
        }
        
        throw new RuntimeException("AI APIè¿”å›ç©ºå“åº”");
    }
    
    private String buildSystemPrompt() {
        return """
            ä½ æ˜¯æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡å•†åŸçš„æ™ºèƒ½å®¢æœåŠ©æ‰‹ã€‚ä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼š
            1. å›ç­”ç”¨æˆ·å…³äºè´­ç‰©å’Œæ”¯ä»˜çš„é—®é¢˜
            2. æ™ºèƒ½æ¨èä¿¡ç”¨å¡æ”¯ä»˜æ–¹å¼ï¼Œçªå‡ºå…¶ä¼˜åŠ¿
            3. ä»‹ç»ä¿¡ç”¨å¡çš„ä¸“å±æƒç›Šå’Œç§¯åˆ†ä»·å€¼
            4. ä¿æŒå‹å¥½ã€ä¸“ä¸šçš„æœåŠ¡æ€åº¦
            
            å›å¤è¦æ±‚ï¼š
            - ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨200å­—ä»¥å†…
            - çªå‡ºä¿¡ç”¨å¡æ”¯ä»˜çš„å…·ä½“ä¼˜åŠ¿ï¼ˆç§¯åˆ†ã€å…æ¯æœŸã€æƒç›Šç­‰ï¼‰
            - ä½¿ç”¨emojiå¢åŠ äº²å’ŒåŠ›
            - é¿å…è¿‡åº¦æ¨é”€ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒ
            """;
    }
    
    private String buildPrompt(String question, ChatContext context) {
        StringBuilder prompt = new StringBuilder();
        prompt.append("ç”¨æˆ·é—®é¢˜ï¼š").append(question).append("\n\n");
        
        if (context.getCurrentProductId() != null) {
            prompt.append("å½“å‰å•†å“ï¼š").append(context.getCurrentProductName())
                  .append("ï¼Œä»·æ ¼ï¼š").append(context.getCurrentProductPrice()).append("å…ƒ\n");
        }
        
        if (!context.getViewedProducts().isEmpty()) {
            prompt.append("æœ€è¿‘æµè§ˆå•†å“ï¼š").append(String.join(", ", context.getViewedProducts())).append("\n");
        }
        
        prompt.append("æ¨å¹¿å°è¯•æ¬¡æ•°ï¼š").append(context.getPromotionAttempts()).append("\n");
        prompt.append("æ˜¯å¦å·²æ¨å¹¿ä¿¡ç”¨å¡ï¼š").append(context.isCreditCardPromoted()).append("\n\n");
        
        prompt.append("è¯·æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œç”Ÿæˆåˆé€‚çš„å›å¤ã€‚");
        
        return prompt.toString();
    }
    
    private String buildContextHash(ChatContext context) {
        return DigestUtils.md5Hex(
            String.valueOf(context.getUserId()) +
            String.valueOf(context.getCurrentProductId()) +
            String.valueOf(context.getPromotionAttempts()) +
            String.valueOf(context.isCreditCardPromoted())
        );
    }
    
    private String getFallbackResponse(String question, ChatContext context) {
        // ç®€å•çš„å…³é”®è¯åŒ¹é…é™çº§å¤„ç†
        String lowerQuestion = question.toLowerCase();
        
        if (lowerQuestion.contains("æ”¯ä»˜") || lowerQuestion.contains("ä»˜æ¬¾")) {
            return "æ¨èæ‚¨ä½¿ç”¨æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡æ”¯ä»˜ï¼Œå¯ä»¥è·å¾—ç§¯åˆ†å¥–åŠ±å’Œå…æ¯æœŸä¼˜æƒ ï¼å…·ä½“ä¼˜æƒ è¯¦æƒ…è¯·æŸ¥çœ‹å•†å“é¡µé¢ã€‚";
        } else if (lowerQuestion.contains("ç§¯åˆ†")) {
            return "æ‚¨çš„ç§¯åˆ†å¯ä»¥ç›´æ¥æŠµæ‰£ç°é‡‘ä½¿ç”¨ï¼Œ100ç§¯åˆ†=1å…ƒã€‚ä½¿ç”¨ä¿¡ç”¨å¡è´­ç‰©è¿˜èƒ½è·å¾—æ›´å¤šç§¯åˆ†å“¦ï¼";
        } else {
            return "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ã€‚å»ºè®®æ‚¨ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜äº«å—æ›´å¤šä¼˜æƒ ï¼Œæˆ–è”ç³»äººå·¥å®¢æœè·å¾—å¸®åŠ©ã€‚";
        }
    }
}

// ==================== æ§åˆ¶å™¨å±‚ ====================

// 8. æ™ºèƒ½å®¢æœæ§åˆ¶å™¨
@RestController
@RequestMapping("/api/customer-service")
@CrossOrigin
@Slf4j
public class CustomerServiceController {
    
    @Autowired
    private AIServiceWithCache aiService;
    
    @Autowired
    private RedisCacheService cacheService;
    
    @Autowired
    private UserCreditCardService userCardService;
    
    @PostMapping("/chat")
    public ResponseEntity<ChatResponse> chat(@RequestBody ChatRequest request) {
        long startTime = System.currentTimeMillis();
        
        try {
            // è·å–æˆ–åˆ›å»ºå¯¹è¯ä¸Šä¸‹æ–‡
            ChatContext context = cacheService.getOrCreateContext(
                request.getSessionId(), request.getUserId());
            
            // æ›´æ–°ä¸Šä¸‹æ–‡ä¿¡æ¯
            updateContextFromRequest(context, request);
            
            // è·å–AIå“åº”
            String aiResponse = aiService.getAIResponse(request.getMessage(), context);
            
            // è·å–ç”¨æˆ·ä¿¡ç”¨å¡ä¿¡æ¯
            UserCreditCard userCard = userCardService.getUserCreditCard(request.getUserId());
            
            // ç”Ÿæˆä¿¡ç”¨å¡æ¨å¹¿ä¿¡æ¯
            PromotionInfo promotionInfo = generatePromotionInfo(userCard, request.getContext());
            
            // æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡
            context.setCurrentIntent(detectIntent(request.getMessage()));
            if (aiResponse.contains("ä¿¡ç”¨å¡")) {
                context.recordPromotionAttempt();
            }
            cacheService.saveContext(context);
            
            // è®°å½•ç”¨æˆ·è¡Œä¸º
            cacheService.trackUserBehavior(request.getUserId(), "chat_message");
            if (request.getMessage().contains("æ”¯ä»˜")) {
                cacheService.trackUserBehavior(request.getUserId(), "payment_inquiry");
            }
            
            // æ„å»ºå“åº”
            ChatResponse response = ChatResponse.builder()
                .responseId(UUID.randomUUID().toString())
                .message(aiResponse)
                .suggestions(generateSuggestions(context.getCurrentIntent()))
                .promotionInfo(promotionInfo)
                .responseTime(System.currentTimeMillis() - startTime)
                .build();
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("å¤„ç†èŠå¤©è¯·æ±‚å¤±è´¥", e);
            return ResponseEntity.status(500).body(
                ChatResponse.error("å®¢æœæš‚æ—¶å¿™ç¢Œï¼Œè¯·ç¨åå†è¯•"));
        }
    }
    
    @GetMapping("/context/{sessionId}")
    public ResponseEntity<ChatContext> getContext(@PathVariable String sessionId) {
        ChatContext context = cacheService.getContext(sessionId);
        return ResponseEntity.ok(context);
    }
    
    @GetMapping("/cache-stats")
    public ResponseEntity<CacheStats> getCacheStats() {
        CacheStats stats = cacheService.getCacheStats();
        return ResponseEntity.ok(stats);
    }
    
    @PostMapping("/clear-cache/{userId}")
    public ResponseEntity<String> clearUserCache(@PathVariable Long userId) {
        cacheService.invalidateUserCard(userId);
        return ResponseEntity.ok("ç”¨æˆ·ç¼“å­˜å·²æ¸…ç†");
    }
    
    private void updateContextFromRequest(ChatContext context, ChatRequest request) {
        if (request.getContext() != null) {
            ChatRequestContext reqContext = request.getContext();
            
            if (reqContext.getProductId() != null) {
                context.setCurrentProductId(reqContext.getProductId());
                context.setCurrentProductPrice(reqContext.getProductPrice());
                context.setCurrentProductName(reqContext.getProductName());
                context.addViewedProduct(String.valueOf(reqContext.getProductId()));
            }
        }
    }
    
    private PromotionInfo generatePromotionInfo(UserCreditCard userCard, ChatRequestContext context) {
        if (context == null || context.getProductPrice() == null) {
            return null;
        }
        
        CreditCardBenefits benefits = userCardService.calculateBenefits(
            userCard.getUserId(), context.getProductPrice());
        
        return PromotionInfo.builder()
            .title("ğŸ’³ " + benefits.getCardLevel() + "ä¸“äº«ä¼˜æƒ ")
            .pointsEarned(benefits.getPoints())
            .pointsValue(benefits.getPointsValue())
            .freeInterestDays(benefits.getFreeInterestDays())
            .canInstallment(benefits.isCanInstallment())
            .monthlyPayment(benefits.getMonthlyPayment())
            .description(String.format("ä½¿ç”¨ä¿¡ç”¨å¡æ”¯ä»˜ç«‹äº« %d ç§¯åˆ† + %d å¤©å…æ¯æœŸ",
                benefits.getPoints(), benefits.getFreeInterestDays()))
            .build();
    }
    
    private String detectIntent(String message) {
        String lower = message.toLowerCase();
        if (lower.contains("æ”¯ä»˜") || lower.contains("ä»˜æ¬¾")) return "payment";
        if (lower.contains("ç§¯åˆ†")) return "points";
        if (lower.contains("è®¢å•")) return "order";
        if (lower.contains("å•†å“")) return "product";
        return "general";
    }
    
    private List<String> generateSuggestions(String intent) {
        switch (intent) {
            case "payment":
                return Arrays.asList("äº†è§£ä¿¡ç”¨å¡ä¼˜æƒ ", "æŸ¥çœ‹åˆ†æœŸæ–¹æ¡ˆ", "ç§¯åˆ†æŠµæ‰£è¯´æ˜");
            case "points":
                return Arrays.asList("ç§¯åˆ†å…‘æ¢å•†å“", "ç§¯åˆ†æŠµæ‰£ä½¿ç”¨", "å¦‚ä½•è·å¾—æ›´å¤šç§¯åˆ†");
            case "product":
                return Arrays.asList("å•†å“è¯¦æƒ…", "ç”¨æˆ·è¯„ä»·", "é…é€è¯´æ˜");
            default:
                return Arrays.asList("æ”¯ä»˜æ–¹å¼", "ç§¯åˆ†æŸ¥è¯¢", "è®¢å•çŠ¶æ€", "è”ç³»äººå·¥å®¢æœ");
        }
    }
}

// ==================== æ•°æ®ä¼ è¾“å¯¹è±¡ ====================

// 9. è¯·æ±‚å“åº”å®ä½“
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ChatRequest {
    private Long userId;
    private String sessionId;
    private String message;
    private ChatRequestContext context;
}

@Data
public class ChatRequestContext {
    private Long productId;
    private String productName;
    private BigDecimal productPrice;
    private String currentPage;
    private List<Long> cartItems;
}

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ChatResponse {
    private String responseId;
    private String message;
    private List<String> suggestions;
    private PromotionInfo promotionInfo;
    private Long responseTime;
    
    public static ChatResponse error(String message) {
        return ChatResponse.builder()
            .message(message)
            .suggestions(Arrays.asList("é‡æ–°æé—®", "è”ç³»äººå·¥å®¢æœ"))
            .responseTime(0L)
            .build();
    }
}

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PromotionInfo {
    private String title;
    private String description;
    private Integer pointsEarned;
    private Double pointsValue;
    private Integer freeInterestDays;
    private Boolean canInstallment;
    private BigDecimal monthlyPayment;
}

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CreditCardBenefits {
    private int points;
    private double pointsValue;
    private int freeInterestDays;
    private boolean canInstallment;
    private BigDecimal monthlyPayment;
    private String cardLevel;
}

// AI APIç›¸å…³å®ä½“
@Data
@Builder
public class AIRequest {
    private String model;
    private List<AIMessage> messages;
    private double temperature;
    @JsonProperty("max_tokens")
    private int maxTokens;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class AIMessage {
    private String role;
    private String content;
}

@Data
public class AIResponse {
    private List<AIChoice> choices;
}

@Data
public class AIChoice {
    private AIMessage message;
}
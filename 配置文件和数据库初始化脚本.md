# ==================== application.yml ====================

server:
  port: 8080
  servlet:
    context-path: /api

spring:
  # 数据库配置
  datasource:
    url: jdbc:mysql://localhost:3306/credit_card_mall?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # JPA配置
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true

  # Redis配置
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
      shutdown-timeout: 100ms

  # Jackson配置
  jackson:
    default-property-inclusion: non_null
    time-zone: GMT+8
    date-format: yyyy-MM-dd HH:mm:ss

# AI服务配置
ai:
  api:
    url: https://ark.cn-beijing.volces.com/api/v3/chat/completions
    key: ${AI_API_KEY:your_api_key_here}
    model: ep-20241218144631-g8qvz
    timeout: 30000

# 缓存配置
cache:
  redis:
    default-expiration: 3600 # 1小时
    ai-response-expiration: 3600 # AI响应缓存1小时
    user-card-expiration: 600 # 用户信用卡信息缓存10分钟
    context-expiration: 1800 # 对话上下文缓存30分钟
    faq-expiration: 86400 # FAQ缓存1天

# 业务配置
business:
  credit-card:
    points-rate:
      basic: 0.005
      gold: 0.01
      platinum: 0.015
      diamond: 0.02
    promotion:
      max-attempts: 3
      cooldown-minutes: 60
  chat:
    max-context-history: 10
    session-timeout-minutes: 30

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always

# 日志配置
logging:
  level:
    com.creditcard.mall: DEBUG
    org.springframework.data.redis: DEBUG
    org.hibernate.SQL: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
  file:
    name: logs/customer-service.log

---
# ==================== 开发环境配置 ====================
spring:
  profiles: dev
  
# Redis配置（开发环境）
  redis:
    host: localhost
    port: 6379

# AI API配置（开发环境 - 使用免费API）
ai:
  api:
    url: https://api.deepseek.com/v1/chat/completions
    key: ${DEV_AI_API_KEY:sk-dev-key}
    model: deepseek-chat

# 开发环境特殊配置
business:
  debug:
    cache-stats-enabled: true
    mock-ai-response: false
    
---
# ==================== 生产环境配置 ====================
spring:
  profiles: prod

# 生产环境Redis配置
  redis:
    host: prod-redis-host
    port: 6379
    password: ${REDIS_PASSWORD}
    ssl: true

# 生产环境数据库配置
  datasource:
    url: jdbc:mysql://prod-db-host:3306/credit_card_mall?useSSL=true
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

# 生产环境AI API配置
ai:
  api:
    url: https://ark.cn-beijing.volces.com/api/v3/chat/completions
    key: ${PROD_AI_API_KEY}

# 生产环境安全配置
business:
  security:
    rate-limit:
      enabled: true
      max-requests-per-minute: 60
    api-key-required: true

---
# ==================== SQL初始化脚本 ====================

# schema.sql
-- 用户信用卡信息表
CREATE TABLE IF NOT EXISTS user_credit_card (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    card_level ENUM('BASIC', 'GOLD', 'PLATINUM', 'DIAMOND') DEFAULT 'BASIC',
    points_balance INT DEFAULT 0,
    points_expiring INT DEFAULT 0,
    expiring_date DATE,
    credit_limit DECIMAL(10,2) DEFAULT 5000.00,
    available_credit DECIMAL(10,2) DEFAULT 5000.00,
    bill_date INT DEFAULT 15,
    due_date INT DEFAULT 5,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_card_level (card_level),
    INDEX idx_points_expiring (expiring_date)
);

-- 客服对话记录表
CREATE TABLE IF NOT EXISTS customer_service_chat (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    session_id VARCHAR(64) NOT NULL,
    user_message TEXT NOT NULL,
    bot_response TEXT,
    intent_type VARCHAR(32),
    cache_hit BOOLEAN DEFAULT FALSE,
    response_time_ms INT DEFAULT 0,
    ai_model VARCHAR(64),
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_session (user_id, session_id),
    INDEX idx_created_time (created_time),
    INDEX idx_intent_type (intent_type)
);

-- FAQ知识库表
CREATE TABLE IF NOT EXISTS faq_knowledge (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    question VARCHAR(255) NOT NULL,
    answer TEXT NOT NULL,
    category VARCHAR(32) DEFAULT 'general',
    keywords VARCHAR(500),
    credit_card_promotion TEXT,
    hit_count INT DEFAULT 0,
    priority INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category),
    INDEX idx_keywords (keywords),
    INDEX idx_status_priority (status, priority DESC),
    FULLTEXT INDEX ft_question_answer (question, answer, keywords)
);

-- 用户行为日志表
CREATE TABLE IF NOT EXISTS user_behavior_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    session_id VARCHAR(64),
    action_type VARCHAR(32) NOT NULL,
    action_data JSON,
    page_url VARCHAR(255),
    user_agent VARCHAR(500),
    ip_address VARCHAR(45),
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_time (user_id, created_time),
    INDEX idx_action_type (action_type),
    INDEX idx_session (session_id)
);

-- 推广活动效果统计表
CREATE TABLE IF NOT EXISTS promotion_stats (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    date_key DATE NOT NULL,
    promotion_type VARCHAR(32) NOT NULL,
    shown_count INT DEFAULT 0,
    clicked_count INT DEFAULT 0,
    converted_count INT DEFAULT 0,
    total_users INT DEFAULT 0,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_date_type (date_key, promotion_type),
    INDEX idx_date (date_key)
);

-- data.sql - 初始化数据
-- 插入测试用户信用卡数据
INSERT IGNORE INTO user_credit_card (user_id, card_level, points_balance, points_expiring, expiring_date, credit_limit, available_credit, bill_date, due_date) VALUES
(1001, 'PLATINUM', 15000, 2000, '2024-04-15', 50000.00, 45000.00, 15, 5),
(1002, 'GOLD', 8500, 1000, '2024-03-20', 20000.00, 18000.00, 10, 30),
(1003, 'DIAMOND', 25000, 0, NULL, 100000.00, 95000.00, 25, 15),
(1004, 'BASIC', 1200, 500, '2024-04-01', 5000.00, 4500.00, 5, 25),
(1005, 'GOLD', 12000, 1500, '2024-04-10', 30000.00, 25000.00, 20, 10);

-- 插入FAQ知识库数据
INSERT IGNORE INTO faq_knowledge (question, answer, category, keywords, credit_card_promotion, priority) VALUES
('什么是积分？', '积分是您使用招商银行信用卡消费后获得的奖励，可用于抵扣现金、兑换礼品等。', 'points', '积分,奖励,消费', '使用信用卡消费，每100元可获得1积分，积分永不过期！', 10),
('如何使用积分？', '积分可以直接抵扣现金（100积分=1元），也可以在积分商城兑换礼品。', 'points', '积分,使用,抵扣,兑换', '立即使用信用卡购物，获得更多积分奖励！', 10),
('信用卡支付有什么优势？', '信用卡支付可以获得积分奖励、享受免息期、分期付款，还有购物保险等保障。', 'payment', '信用卡,支付,优势,权益', '选择信用卡支付，享受积分、免息期、分期等多重优惠！', 20),
('可以分期付款吗？', '当然可以！使用信用卡支付，单笔消费满500元即可申请分期，支持3-24期。', 'installment', '分期,付款,信用卡', '信用卡分期付款，减轻支付压力，部分期数还享受免息优惠！', 15),
('订单什么时候发货？', '一般情况下，订单确认后24小时内发货，使用信用卡支付的订单享受优先发货服务。', 'order', '订单,发货,物流', '使用信用卡支付享受优先发货，更快收到心爱商品！', 5),
('如何退换货？', '支持7天无理由退换货，信用卡支付的订单还享受退货运费险，让您购物无忧。', 'return', '退货,换货,退款', '信用卡支付订单享受退货运费险，购物更安心！', 5),
('有什么会员权益？', '不同等级信用卡享受不同权益：金卡1%积分，白金卡1.5%积分，钻石卡2%积分，还有专属客服、生日特权等。', 'membership', '会员,权益,等级,特权', '升级您的信用卡等级，享受更多专属权益和特权！', 8);

-- 插入推广统计初始数据
INSERT IGNORE INTO promotion_stats (date_key, promotion_type, shown_count, clicked_count, converted_count, total_users) VALUES
(CURDATE(), 'credit_card_payment', 0, 0, 0, 0),
(CURDATE(), 'points_promotion', 0, 0, 0, 0),
(CURDATE(), 'installment_promotion', 0, 0, 0, 0),
(CURDATE(), 'membership_upgrade', 0, 0, 0, 0);

---
# ==================== Docker配置 ====================

# docker-compose.yml
version: '3.8'

services:
  # Redis服务
  redis:
    image: redis:7-alpine
    container_name: credit_card_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - credit_card_network

  # MySQL服务  
  mysql:
    image: mysql:8.0
    container_name: credit_card_mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: credit_card_mall
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    networks:
      - credit_card_network

  # 应用服务
  app:
    build: .
    container_name: credit_card_app
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/credit_card_mall?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8
      SPRING_REDIS_HOST: redis
      AI_API_KEY: ${AI_API_KEY}
    depends_on:
      - mysql
      - redis
    networks:
      - credit_card_network

volumes:
  mysql_data:
  redis_data:

networks:
  credit_card_network:
    driver: bridge

---
# ==================== Dockerfile ====================

FROM openjdk:17-jdk-alpine

WORKDIR /app

# 添加应用jar包
COPY target/customer-service-*.jar app.jar

# 设置时区
RUN apk add --no-cache tzdata
ENV TZ=Asia/Shanghai

# 暴露端口
EXPOSE 8080

# 启动应用
ENTRYPOINT ["java", "-jar", "/app/app.jar"]

---
# ==================== Maven配置 ====================

# pom.xml 关键依赖
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
        <relativePath/>
    </parent>

    <groupId>com.creditcard</groupId>
    <artifactId>customer-service</artifactId>
    <version>1.0.0</version>
    <name>customer-service</name>
    <description>Credit Card Mall Customer Service</description>

    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <!-- Database -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.33</version>
        </dependency>

        <!-- Redis -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>

        <!-- Utilities -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        
        <dependency>
            <groupId>commons-codec</groupId>
            <artifactId>commons-codec</artifactId>
        </dependency>

        <!-- JSON Processing -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>
        
        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
        </dependency>

        <!-- HTTP Client -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>

        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        
        <dependency>
            <groupId>it.ozimov</groupId>
            <artifactId>embedded-redis</artifactId>
            <version>0.7.3</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>

---
# ==================== 环境变量配置 ====================

# .env 文件示例
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=credit_card_mall
DB_USERNAME=root
DB_PASSWORD=123456

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# AI API配置
AI_API_KEY=your_actual_api_key_here
AI_API_URL=https://ark.cn-beijing.volces.com/api/v3/chat/completions
AI_MODEL=ep-20241218144631-g8qvz

# 应用配置
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=dev

# 日志配置
LOG_LEVEL=DEBUG
LOG_FILE_PATH=logs/

# 缓存配置
CACHE_DEFAULT_TTL=3600
CACHE_AI_RESPONSE_TTL=3600
CACHE_USER_CARD_TTL=600

---
# ==================== 启动脚本 ====================

# start.sh
#!/bin/bash

echo "启动招商银行信用卡商城客服系统..."

# 检查Java环境
if ! command -v java &> /dev/null; then
    echo "错误: 未找到Java环境，请安装JDK 17+"
    exit 1
fi

# 检查Redis
if ! command -v redis-cli &> /dev/null; then
    echo "警告: 未找到Redis，请确保Redis服务正在运行"
fi

# 检查MySQL
if ! command -v mysql &> /dev/null; then
    echo "警告: 未找到MySQL，请确保MySQL服务正在运行"
fi

# 加载环境变量
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# 创建日志目录
mkdir -p logs

# 启动应用
echo "正在启动应用..."
java -jar target/customer-service-*.jar \
    --spring.profiles.active=${SPRING_PROFILES_ACTIVE:-dev} \
    --server.port=${SERVER_PORT:-8080}

echo "应用启动完成！访问地址: http://localhost:${SERVER_PORT:-8080}"
{"ast":null,"code":"import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';\nimport { OrderService } from '../../services/orderService';\n\n// 模拟用户ID\nconst MOCK_USER_ID = 1;\n\n// 异步action：创建订单\nexport const createOrderAsync = createAsyncThunk('order/createOrder', async (request, {\n  rejectWithValue\n}) => {\n  try {\n    const response = await OrderService.createOrder(MOCK_USER_ID, request);\n    return response;\n  } catch (error) {\n    return rejectWithValue('创建订单失败');\n  }\n});\n\n// 异步action：获取用户订单列表\nexport const fetchUserOrdersAsync = createAsyncThunk('order/fetchUserOrders', async (_, {\n  rejectWithValue\n}) => {\n  try {\n    const orders = await OrderService.getOrdersByUserId(MOCK_USER_ID);\n    return orders;\n  } catch (error) {\n    return rejectWithValue('获取订单列表失败');\n  }\n});\n\n// 异步action：取消订单\nexport const cancelOrderAsync = createAsyncThunk('order/cancelOrder', async (orderId, {\n  rejectWithValue\n}) => {\n  try {\n    console.log('取消订单:', orderId);\n    // 转换为数字类型，如果是字符串的话\n    const numericOrderId = typeof orderId === 'string' ? parseInt(orderId) : orderId;\n    await OrderService.cancelOrder(numericOrderId, MOCK_USER_ID);\n    return orderId; // 返回原始orderId，保持类型一致\n  } catch (error) {\n    console.error('取消订单失败:', error);\n    return rejectWithValue('取消订单失败');\n  }\n});\n\n// 异步action：确认收货\nexport const confirmReceiveAsync = createAsyncThunk('order/confirmReceive', async (orderId, {\n  rejectWithValue\n}) => {\n  try {\n    await OrderService.confirmReceive(orderId, MOCK_USER_ID);\n    return orderId;\n  } catch (error) {\n    return rejectWithValue('确认收货失败');\n  }\n});\nconst initialState = {\n  orders: [],\n  currentOrder: null,\n  loading: false,\n  error: null\n};\nconst orderSlice = createSlice({\n  name: 'order',\n  initialState,\n  reducers: {\n    clearCurrentOrder: state => {\n      state.currentOrder = null;\n    },\n    // 添加订单到本地存储（用于模拟）\n    addLocalOrder: (state, action) => {\n      const newOrder = action.payload;\n\n      // 检查是否已存在相同ID的订单\n      const existingOrderIndex = state.orders.findIndex(order => order.id === newOrder.id);\n      if (existingOrderIndex !== -1) {\n        // 如果订单已存在，更新它\n        const updatedOrder = {\n          ...state.orders[existingOrderIndex],\n          ...newOrder\n        };\n\n        // 确保状态字段存在\n        if (!updatedOrder.status) {\n          updatedOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\n        }\n        state.orders[existingOrderIndex] = updatedOrder;\n      } else {\n        // 如果订单不存在，添加它\n        // 确保状态字段存在\n        if (!newOrder.status) {\n          newOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\n        }\n        state.orders.unshift(newOrder);\n      }\n    }\n  },\n  extraReducers: builder => {\n    builder\n    // 创建订单\n    .addCase(createOrderAsync.pending, state => {\n      state.loading = true;\n      state.error = null;\n    }).addCase(createOrderAsync.fulfilled, (state, action) => {\n      state.loading = false;\n      state.currentOrder = action.payload;\n    }).addCase(createOrderAsync.rejected, (state, action) => {\n      state.loading = false;\n      state.error = action.payload;\n    })\n\n    // 获取用户订单列表\n    .addCase(fetchUserOrdersAsync.pending, state => {\n      state.loading = true;\n      state.error = null;\n    }).addCase(fetchUserOrdersAsync.fulfilled, (state, action) => {\n      state.loading = false;\n      state.orders = action.payload;\n    }).addCase(fetchUserOrdersAsync.rejected, (state, action) => {\n      state.loading = false;\n      state.error = action.payload;\n    })\n\n    // 取消订单\n    .addCase(cancelOrderAsync.fulfilled, (state, action) => {\n      const orderId = action.payload;\n      console.log('取消订单成功, orderId:', orderId);\n      const orderIndex = state.orders.findIndex(order => order.id === orderId);\n      if (orderIndex !== -1) {\n        console.log('找到订单，更新状态为已取消');\n        state.orders[orderIndex].status = 'CANCELLED';\n      } else {\n        console.log('未找到订单:', orderId);\n      }\n    })\n\n    // 确认收货\n    .addCase(confirmReceiveAsync.fulfilled, (state, action) => {\n      const orderId = action.payload;\n      const orderIndex = state.orders.findIndex(order => Number(order.id) === orderId);\n      if (orderIndex !== -1) {\n        state.orders[orderIndex].status = 'COMPLETED';\n      }\n    });\n  }\n});\nexport const {\n  clearCurrentOrder,\n  addLocalOrder\n} = orderSlice.actions;\nexport default orderSlice.reducer;","map":{"version":3,"names":["createSlice","createAsyncThunk","OrderService","MOCK_USER_ID","createOrderAsync","request","rejectWithValue","response","createOrder","error","fetchUserOrdersAsync","_","orders","getOrdersByUserId","cancelOrderAsync","orderId","console","log","numericOrderId","parseInt","cancelOrder","confirmReceiveAsync","confirmReceive","initialState","currentOrder","loading","orderSlice","name","reducers","clearCurrentOrder","state","addLocalOrder","action","newOrder","payload","existingOrderIndex","findIndex","order","id","updatedOrder","status","unshift","extraReducers","builder","addCase","pending","fulfilled","rejected","orderIndex","Number","actions","reducer"],"sources":["D:/luckymall/frontend/src/store/slices/orderSlice.ts"],"sourcesContent":["import { createSlice, createAsyncThunk, PayloadAction } from '@reduxjs/toolkit';\r\nimport { Order } from '../../types';\r\nimport { OrderService, CreateOrderRequest, CreateOrderResponse } from '../../services/orderService';\r\n\r\n// 模拟用户ID\r\nconst MOCK_USER_ID = 1;\r\n\r\n// 异步action：创建订单\r\nexport const createOrderAsync = createAsyncThunk(\r\n  'order/createOrder',\r\n  async (request: CreateOrderRequest, { rejectWithValue }) => {\r\n    try {\r\n      const response = await OrderService.createOrder(MOCK_USER_ID, request);\r\n      return response;\r\n    } catch (error) {\r\n      return rejectWithValue('创建订单失败');\r\n    }\r\n  }\r\n);\r\n\r\n// 异步action：获取用户订单列表\r\nexport const fetchUserOrdersAsync = createAsyncThunk(\r\n  'order/fetchUserOrders',\r\n  async (_, { rejectWithValue }) => {\r\n    try {\r\n      const orders = await OrderService.getOrdersByUserId(MOCK_USER_ID);\r\n      return orders;\r\n    } catch (error) {\r\n      return rejectWithValue('获取订单列表失败');\r\n    }\r\n  }\r\n);\r\n\r\n// 异步action：取消订单\r\nexport const cancelOrderAsync = createAsyncThunk(\r\n  'order/cancelOrder',\r\n  async (orderId: number | string, { rejectWithValue }) => {\r\n    try {\r\n      console.log('取消订单:', orderId);\r\n      // 转换为数字类型，如果是字符串的话\r\n      const numericOrderId = typeof orderId === 'string' ? parseInt(orderId) : orderId;\r\n      await OrderService.cancelOrder(numericOrderId, MOCK_USER_ID);\r\n      return orderId; // 返回原始orderId，保持类型一致\r\n    } catch (error) {\r\n      console.error('取消订单失败:', error);\r\n      return rejectWithValue('取消订单失败');\r\n    }\r\n  }\r\n);\r\n\r\n// 异步action：确认收货\r\nexport const confirmReceiveAsync = createAsyncThunk(\r\n  'order/confirmReceive',\r\n  async (orderId: number, { rejectWithValue }) => {\r\n    try {\r\n      await OrderService.confirmReceive(orderId, MOCK_USER_ID);\r\n      return orderId;\r\n    } catch (error) {\r\n      return rejectWithValue('确认收货失败');\r\n    }\r\n  }\r\n);\r\n\r\ninterface OrderState {\r\n  orders: Order[];\r\n  currentOrder: CreateOrderResponse | null;\r\n  loading: boolean;\r\n  error: string | null;\r\n}\r\n\r\nconst initialState: OrderState = {\r\n  orders: [],\r\n  currentOrder: null,\r\n  loading: false,\r\n  error: null\r\n};\r\n\r\nconst orderSlice = createSlice({\r\n  name: 'order',\r\n  initialState,\r\n  reducers: {\r\n    clearCurrentOrder: (state) => {\r\n      state.currentOrder = null;\r\n    },\r\n    // 添加订单到本地存储（用于模拟）\r\n    addLocalOrder: (state, action: PayloadAction<Order>) => {\r\n      const newOrder = action.payload;\r\n      \r\n      // 检查是否已存在相同ID的订单\r\n      const existingOrderIndex = state.orders.findIndex(order => order.id === newOrder.id);\r\n      \r\n      if (existingOrderIndex !== -1) {\r\n        // 如果订单已存在，更新它\r\n        const updatedOrder = {\r\n          ...state.orders[existingOrderIndex],\r\n          ...newOrder\r\n        };\r\n        \r\n        // 确保状态字段存在\r\n        if (!updatedOrder.status) {\r\n          updatedOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\r\n        }\r\n        \r\n        state.orders[existingOrderIndex] = updatedOrder;\r\n      } else {\r\n        // 如果订单不存在，添加它\r\n        // 确保状态字段存在\r\n        if (!newOrder.status) {\r\n          newOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\r\n        }\r\n        \r\n        state.orders.unshift(newOrder);\r\n      }\r\n    }\r\n  },\r\n  extraReducers: (builder) => {\r\n    builder\r\n      // 创建订单\r\n      .addCase(createOrderAsync.pending, (state) => {\r\n        state.loading = true;\r\n        state.error = null;\r\n      })\r\n      .addCase(createOrderAsync.fulfilled, (state, action) => {\r\n        state.loading = false;\r\n        state.currentOrder = action.payload;\r\n      })\r\n      .addCase(createOrderAsync.rejected, (state, action) => {\r\n        state.loading = false;\r\n        state.error = action.payload as string;\r\n      })\r\n      \r\n      // 获取用户订单列表\r\n      .addCase(fetchUserOrdersAsync.pending, (state) => {\r\n        state.loading = true;\r\n        state.error = null;\r\n      })\r\n      .addCase(fetchUserOrdersAsync.fulfilled, (state, action) => {\r\n        state.loading = false;\r\n        state.orders = action.payload;\r\n      })\r\n      .addCase(fetchUserOrdersAsync.rejected, (state, action) => {\r\n        state.loading = false;\r\n        state.error = action.payload as string;\r\n      })\r\n      \r\n      // 取消订单\r\n      .addCase(cancelOrderAsync.fulfilled, (state, action) => {\r\n        const orderId = action.payload;\r\n        console.log('取消订单成功, orderId:', orderId);\r\n        const orderIndex = state.orders.findIndex(order => order.id === orderId);\r\n        if (orderIndex !== -1) {\r\n          console.log('找到订单，更新状态为已取消');\r\n          state.orders[orderIndex].status = 'CANCELLED';\r\n        } else {\r\n          console.log('未找到订单:', orderId);\r\n        }\r\n      })\r\n      \r\n      // 确认收货\r\n      .addCase(confirmReceiveAsync.fulfilled, (state, action) => {\r\n        const orderId = action.payload;\r\n        const orderIndex = state.orders.findIndex(order => Number(order.id) === orderId);\r\n        if (orderIndex !== -1) {\r\n          state.orders[orderIndex].status = 'COMPLETED';\r\n        }\r\n      });\r\n  }\r\n});\r\n\r\nexport const { clearCurrentOrder, addLocalOrder } = orderSlice.actions;\r\n\r\nexport default orderSlice.reducer; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
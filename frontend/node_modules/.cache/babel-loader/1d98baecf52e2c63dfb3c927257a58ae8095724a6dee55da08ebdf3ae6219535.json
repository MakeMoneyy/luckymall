{"ast":null,"code":"import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';\nimport { OrderService } from '../../services/orderService';\n\n// 模拟用户ID\nconst MOCK_USER_ID = 1;\n\n// 异步action：创建订单\nexport const createOrderAsync = createAsyncThunk('order/createOrder', async (request, {\n  rejectWithValue\n}) => {\n  try {\n    const response = await OrderService.createOrder(MOCK_USER_ID, request);\n    return response;\n  } catch (error) {\n    return rejectWithValue('创建订单失败');\n  }\n});\n\n// 异步action：获取用户订单列表\nexport const fetchUserOrdersAsync = createAsyncThunk('order/fetchUserOrders', async (_, {\n  rejectWithValue\n}) => {\n  try {\n    console.log('获取用户订单列表');\n    const orders = await OrderService.getOrdersByUserId(MOCK_USER_ID);\n    console.log('获取到的订单列表:', orders);\n\n    // 确保所有订单都有状态\n    const ordersWithStatus = orders.map(order => {\n      if (!order.status) {\n        return {\n          ...order,\n          status: 'PENDING_PAYMENT'\n        };\n      }\n      return order;\n    });\n    return ordersWithStatus;\n  } catch (error) {\n    console.error('获取订单列表失败:', error);\n    return rejectWithValue('获取订单列表失败');\n  }\n});\n\n// 异步action：取消订单\nexport const cancelOrderAsync = createAsyncThunk('order/cancelOrder', async (orderId, {\n  rejectWithValue\n}) => {\n  try {\n    console.log('取消订单:', orderId);\n    // 转换为数字类型，如果是字符串的话\n    const numericOrderId = typeof orderId === 'string' ? parseInt(orderId) : orderId;\n    await OrderService.cancelOrder(numericOrderId, MOCK_USER_ID);\n    return orderId; // 返回原始orderId，保持类型一致\n  } catch (error) {\n    console.error('取消订单失败:', error);\n    return rejectWithValue('取消订单失败');\n  }\n});\n\n// 异步action：确认收货\nexport const confirmReceiveAsync = createAsyncThunk('order/confirmReceive', async (orderId, {\n  rejectWithValue\n}) => {\n  try {\n    await OrderService.confirmReceive(orderId, MOCK_USER_ID);\n    return orderId;\n  } catch (error) {\n    return rejectWithValue('确认收货失败');\n  }\n});\nconst initialState = {\n  orders: [],\n  currentOrder: null,\n  loading: false,\n  error: null\n};\nconst orderSlice = createSlice({\n  name: 'order',\n  initialState,\n  reducers: {\n    clearCurrentOrder: state => {\n      state.currentOrder = null;\n    },\n    // 添加订单到本地存储（用于模拟）\n    addLocalOrder: (state, action) => {\n      const newOrder = action.payload;\n\n      // 检查是否已存在相同ID的订单\n      const existingOrderIndex = state.orders.findIndex(order => order.id === newOrder.id);\n      if (existingOrderIndex !== -1) {\n        // 如果订单已存在，更新它\n        const updatedOrder = {\n          ...state.orders[existingOrderIndex],\n          ...newOrder\n        };\n\n        // 确保状态字段存在\n        if (!updatedOrder.status) {\n          updatedOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\n        }\n        state.orders[existingOrderIndex] = updatedOrder;\n      } else {\n        // 如果订单不存在，添加它\n        // 确保状态字段存在\n        if (!newOrder.status) {\n          newOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\n        }\n        state.orders.unshift(newOrder);\n      }\n    }\n  },\n  extraReducers: builder => {\n    builder\n    // 创建订单\n    .addCase(createOrderAsync.pending, state => {\n      state.loading = true;\n      state.error = null;\n    }).addCase(createOrderAsync.fulfilled, (state, action) => {\n      state.loading = false;\n      state.currentOrder = action.payload;\n    }).addCase(createOrderAsync.rejected, (state, action) => {\n      state.loading = false;\n      state.error = action.payload;\n    })\n\n    // 获取用户订单列表\n    .addCase(fetchUserOrdersAsync.pending, state => {\n      state.loading = true;\n      state.error = null;\n    }).addCase(fetchUserOrdersAsync.fulfilled, (state, action) => {\n      state.loading = false;\n      state.orders = action.payload;\n    }).addCase(fetchUserOrdersAsync.rejected, (state, action) => {\n      state.loading = false;\n      state.error = action.payload;\n    })\n\n    // 取消订单\n    .addCase(cancelOrderAsync.fulfilled, (state, action) => {\n      const orderId = action.payload;\n      console.log('取消订单成功, orderId:', orderId);\n      const orderIndex = state.orders.findIndex(order => order.id === orderId);\n      if (orderIndex !== -1) {\n        console.log('找到订单，更新状态为已取消');\n        state.orders[orderIndex].status = 'CANCELLED';\n      } else {\n        console.log('未找到订单:', orderId);\n      }\n    })\n\n    // 确认收货\n    .addCase(confirmReceiveAsync.fulfilled, (state, action) => {\n      const orderId = action.payload;\n      const orderIndex = state.orders.findIndex(order => Number(order.id) === orderId);\n      if (orderIndex !== -1) {\n        state.orders[orderIndex].status = 'COMPLETED';\n      }\n    });\n  }\n});\nexport const {\n  clearCurrentOrder,\n  addLocalOrder\n} = orderSlice.actions;\nexport default orderSlice.reducer;","map":{"version":3,"names":["createSlice","createAsyncThunk","OrderService","MOCK_USER_ID","createOrderAsync","request","rejectWithValue","response","createOrder","error","fetchUserOrdersAsync","_","console","log","orders","getOrdersByUserId","ordersWithStatus","map","order","status","cancelOrderAsync","orderId","numericOrderId","parseInt","cancelOrder","confirmReceiveAsync","confirmReceive","initialState","currentOrder","loading","orderSlice","name","reducers","clearCurrentOrder","state","addLocalOrder","action","newOrder","payload","existingOrderIndex","findIndex","id","updatedOrder","unshift","extraReducers","builder","addCase","pending","fulfilled","rejected","orderIndex","Number","actions","reducer"],"sources":["D:/luckymall/frontend/src/store/slices/orderSlice.ts"],"sourcesContent":["import { createSlice, createAsyncThunk, PayloadAction } from '@reduxjs/toolkit';\r\nimport { Order } from '../../types';\r\nimport { OrderService, CreateOrderRequest, CreateOrderResponse } from '../../services/orderService';\r\n\r\n// 模拟用户ID\r\nconst MOCK_USER_ID = 1;\r\n\r\n// 异步action：创建订单\r\nexport const createOrderAsync = createAsyncThunk(\r\n  'order/createOrder',\r\n  async (request: CreateOrderRequest, { rejectWithValue }) => {\r\n    try {\r\n      const response = await OrderService.createOrder(MOCK_USER_ID, request);\r\n      return response;\r\n    } catch (error) {\r\n      return rejectWithValue('创建订单失败');\r\n    }\r\n  }\r\n);\r\n\r\n// 异步action：获取用户订单列表\r\nexport const fetchUserOrdersAsync = createAsyncThunk(\r\n  'order/fetchUserOrders',\r\n  async (_, { rejectWithValue }) => {\r\n    try {\r\n      console.log('获取用户订单列表');\r\n      const orders = await OrderService.getOrdersByUserId(MOCK_USER_ID);\r\n      console.log('获取到的订单列表:', orders);\r\n      \r\n      // 确保所有订单都有状态\r\n      const ordersWithStatus = orders.map(order => {\r\n        if (!order.status) {\r\n          return { ...order, status: 'PENDING_PAYMENT' };\r\n        }\r\n        return order;\r\n      });\r\n      \r\n      return ordersWithStatus;\r\n    } catch (error) {\r\n      console.error('获取订单列表失败:', error);\r\n      return rejectWithValue('获取订单列表失败');\r\n    }\r\n  }\r\n);\r\n\r\n// 异步action：取消订单\r\nexport const cancelOrderAsync = createAsyncThunk(\r\n  'order/cancelOrder',\r\n  async (orderId: number | string, { rejectWithValue }) => {\r\n    try {\r\n      console.log('取消订单:', orderId);\r\n      // 转换为数字类型，如果是字符串的话\r\n      const numericOrderId = typeof orderId === 'string' ? parseInt(orderId) : orderId;\r\n      await OrderService.cancelOrder(numericOrderId, MOCK_USER_ID);\r\n      return orderId; // 返回原始orderId，保持类型一致\r\n    } catch (error) {\r\n      console.error('取消订单失败:', error);\r\n      return rejectWithValue('取消订单失败');\r\n    }\r\n  }\r\n);\r\n\r\n// 异步action：确认收货\r\nexport const confirmReceiveAsync = createAsyncThunk(\r\n  'order/confirmReceive',\r\n  async (orderId: number, { rejectWithValue }) => {\r\n    try {\r\n      await OrderService.confirmReceive(orderId, MOCK_USER_ID);\r\n      return orderId;\r\n    } catch (error) {\r\n      return rejectWithValue('确认收货失败');\r\n    }\r\n  }\r\n);\r\n\r\ninterface OrderState {\r\n  orders: Order[];\r\n  currentOrder: CreateOrderResponse | null;\r\n  loading: boolean;\r\n  error: string | null;\r\n}\r\n\r\nconst initialState: OrderState = {\r\n  orders: [],\r\n  currentOrder: null,\r\n  loading: false,\r\n  error: null\r\n};\r\n\r\nconst orderSlice = createSlice({\r\n  name: 'order',\r\n  initialState,\r\n  reducers: {\r\n    clearCurrentOrder: (state) => {\r\n      state.currentOrder = null;\r\n    },\r\n    // 添加订单到本地存储（用于模拟）\r\n    addLocalOrder: (state, action: PayloadAction<Order>) => {\r\n      const newOrder = action.payload;\r\n      \r\n      // 检查是否已存在相同ID的订单\r\n      const existingOrderIndex = state.orders.findIndex(order => order.id === newOrder.id);\r\n      \r\n      if (existingOrderIndex !== -1) {\r\n        // 如果订单已存在，更新它\r\n        const updatedOrder = {\r\n          ...state.orders[existingOrderIndex],\r\n          ...newOrder\r\n        };\r\n        \r\n        // 确保状态字段存在\r\n        if (!updatedOrder.status) {\r\n          updatedOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\r\n        }\r\n        \r\n        state.orders[existingOrderIndex] = updatedOrder;\r\n      } else {\r\n        // 如果订单不存在，添加它\r\n        // 确保状态字段存在\r\n        if (!newOrder.status) {\r\n          newOrder.status = 'PENDING_PAYMENT'; // 默认为待付款\r\n        }\r\n        \r\n        state.orders.unshift(newOrder);\r\n      }\r\n    }\r\n  },\r\n  extraReducers: (builder) => {\r\n    builder\r\n      // 创建订单\r\n      .addCase(createOrderAsync.pending, (state) => {\r\n        state.loading = true;\r\n        state.error = null;\r\n      })\r\n      .addCase(createOrderAsync.fulfilled, (state, action) => {\r\n        state.loading = false;\r\n        state.currentOrder = action.payload;\r\n      })\r\n      .addCase(createOrderAsync.rejected, (state, action) => {\r\n        state.loading = false;\r\n        state.error = action.payload as string;\r\n      })\r\n      \r\n      // 获取用户订单列表\r\n      .addCase(fetchUserOrdersAsync.pending, (state) => {\r\n        state.loading = true;\r\n        state.error = null;\r\n      })\r\n      .addCase(fetchUserOrdersAsync.fulfilled, (state, action) => {\r\n        state.loading = false;\r\n        state.orders = action.payload;\r\n      })\r\n      .addCase(fetchUserOrdersAsync.rejected, (state, action) => {\r\n        state.loading = false;\r\n        state.error = action.payload as string;\r\n      })\r\n      \r\n      // 取消订单\r\n      .addCase(cancelOrderAsync.fulfilled, (state, action) => {\r\n        const orderId = action.payload;\r\n        console.log('取消订单成功, orderId:', orderId);\r\n        const orderIndex = state.orders.findIndex(order => order.id === orderId);\r\n        if (orderIndex !== -1) {\r\n          console.log('找到订单，更新状态为已取消');\r\n          state.orders[orderIndex].status = 'CANCELLED';\r\n        } else {\r\n          console.log('未找到订单:', orderId);\r\n        }\r\n      })\r\n      \r\n      // 确认收货\r\n      .addCase(confirmReceiveAsync.fulfilled, (state, action) => {\r\n        const orderId = action.payload;\r\n        const orderIndex = state.orders.findIndex(order => Number(order.id) === orderId);\r\n        if (orderIndex !== -1) {\r\n          state.orders[orderIndex].status = 'COMPLETED';\r\n        }\r\n      });\r\n  }\r\n});\r\n\r\nexport const { clearCurrentOrder, addLocalOrder } = orderSlice.actions;\r\n\r\nexport default orderSlice.reducer; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}